-- Hotel Management System Database Schema

CREATE DATABASE IF NOT EXISTS hotel_management;
USE hotel_management;

-- Table for storing room types
CREATE TABLE room_types (
    type_id INT PRIMARY KEY AUTO_INCREMENT,
    type_name VARCHAR(50) NOT NULL UNIQUE,
    base_price DECIMAL(10, 2) NOT NULL,
    capacity INT NOT NULL,
    description TEXT
);

-- Table for storing rooms
CREATE TABLE rooms (
    room_id INT PRIMARY KEY AUTO_INCREMENT,
    room_number VARCHAR(10) NOT NULL UNIQUE,
    type_id INT NOT NULL,
    floor_number INT,
    status ENUM('AVAILABLE', 'OCCUPIED', 'MAINTENANCE') DEFAULT 'AVAILABLE',
    FOREIGN KEY (type_id) REFERENCES room_types(type_id) ON DELETE RESTRICT
);

-- Table for storing guest information
CREATE TABLE guests (
    guest_id INT PRIMARY KEY AUTO_INCREMENT,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(15) NOT NULL,
    id_proof VARCHAR(50) NOT NULL,
    address TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Table for storing staff/admin users
CREATE TABLE staff (
    staff_id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    role ENUM('ADMIN', 'RECEPTIONIST', 'MANAGER') NOT NULL,
    email VARCHAR(100),
    phone VARCHAR(15),
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Table for storing bookings
CREATE TABLE bookings (
    booking_id INT PRIMARY KEY AUTO_INCREMENT,
    guest_id INT NOT NULL,
    room_id INT NOT NULL,
    check_in_date DATE NOT NULL,
    check_out_date DATE NOT NULL,
    num_guests INT NOT NULL,
    total_amount DECIMAL(10, 2) NOT NULL,
    booking_status ENUM('CONFIRMED', 'CHECKED_IN', 'CHECKED_OUT', 'CANCELLED') DEFAULT 'CONFIRMED',
    special_requests TEXT,
    booked_by INT NOT NULL,
    booking_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (guest_id) REFERENCES guests(guest_id) ON DELETE CASCADE,
    FOREIGN KEY (room_id) REFERENCES rooms(room_id) ON DELETE RESTRICT,
    FOREIGN KEY (booked_by) REFERENCES staff(staff_id) ON DELETE RESTRICT
);

-- Table for storing payments
CREATE TABLE payments (
    payment_id INT PRIMARY KEY AUTO_INCREMENT,
    booking_id INT NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    payment_method ENUM('CASH', 'CARD', 'UPI', 'ONLINE') NOT NULL,
    payment_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    payment_status ENUM('PENDING', 'COMPLETED', 'REFUNDED') DEFAULT 'COMPLETED',
    FOREIGN KEY (booking_id) REFERENCES bookings(booking_id) ON DELETE CASCADE
);

-- Indexes for better performance
CREATE INDEX idx_room_status ON rooms(status);
CREATE INDEX idx_booking_dates ON bookings(check_in_date, check_out_date);
CREATE INDEX idx_guest_phone ON guests(phone);
CREATE INDEX idx_booking_status ON bookings(booking_status);

-- Insert default room types
INSERT INTO room_types (type_name, base_price, capacity, description) VALUES
('Single', 1500.00, 1, 'Comfortable single occupancy room'),
('Double', 2500.00, 2, 'Spacious double occupancy room'),
('Deluxe', 4000.00, 3, 'Deluxe room with premium amenities'),
('Suite', 6000.00, 4, 'Luxury suite with separate living area');

-- Insert sample rooms
INSERT INTO rooms (room_number, type_id, floor_number, status) VALUES
('101', 1, 1, 'AVAILABLE'),
('102', 1, 1, 'AVAILABLE'),
('201', 2, 2, 'AVAILABLE'),
('202', 2, 2, 'AVAILABLE'),
('301', 3, 3, 'AVAILABLE'),
('302', 3, 3, 'AVAILABLE'),
('401', 4, 4, 'AVAILABLE');

-- Insert default admin user (password: admin123)
INSERT INTO staff (username, password, full_name, role, email, phone) VALUES
('admin', 'admin123', 'System Administrator', 'ADMIN', 'admin@hotel.com', '9876543210'),
('reception', 'reception123', 'Reception Desk', 'RECEPTIONIST', 'reception@hotel.com', '9876543211');

-- Stored Procedure: Check room availability
DELIMITER //
CREATE PROCEDURE check_room_availability(
    IN p_check_in DATE,
    IN p_check_out DATE,
    IN p_room_type INT
)
BEGIN
    SELECT r.room_id, r.room_number, rt.type_name, rt.base_price, r.floor_number
    FROM rooms r
    INNER JOIN room_types rt ON r.type_id = rt.type_id
    WHERE r.status = 'AVAILABLE'
    AND (p_room_type IS NULL OR r.type_id = p_room_type)
    AND r.room_id NOT IN (
        SELECT room_id FROM bookings
        WHERE booking_status IN ('CONFIRMED', 'CHECKED_IN')
        AND (
            (check_in_date <= p_check_in AND check_out_date > p_check_in)
            OR (check_in_date < p_check_out AND check_out_date >= p_check_out)
            OR (check_in_date >= p_check_in AND check_out_date <= p_check_out)
        )
    );
END //
DELIMITER ;

-- Stored Procedure: Get booking details
DELIMITER //
CREATE PROCEDURE get_booking_details(IN p_booking_id INT)
BEGIN
    SELECT 
        b.booking_id,
        CONCAT(g.first_name, ' ', g.last_name) AS guest_name,
        g.phone,
        r.room_number,
        rt.type_name,
        b.check_in_date,
        b.check_out_date,
        b.num_guests,
        b.total_amount,
        b.booking_status,
        s.full_name AS booked_by
    FROM bookings b
    INNER JOIN guests g ON b.guest_id = g.guest_id
    INNER JOIN rooms r ON b.room_id = r.room_id
    INNER JOIN room_types rt ON r.type_id = rt.type_id
    INNER JOIN staff s ON b.booked_by = s.staff_id
    WHERE b.booking_id = p_booking_id;
END //
DELIMITER ;

-- Trigger: Update room status on booking
DELIMITER //
CREATE TRIGGER after_booking_insert
AFTER INSERT ON bookings
FOR EACH ROW
BEGIN
    IF NEW.booking_status = 'CONFIRMED' THEN
        UPDATE rooms SET status = 'OCCUPIED' WHERE room_id = NEW.room_id;
    END IF;
END //
DELIMITER ;

-- Trigger: Update room status on checkout
DELIMITER //
CREATE TRIGGER after_booking_update
AFTER UPDATE ON bookings
FOR EACH ROW
BEGIN
    IF NEW.booking_status = 'CHECKED_OUT' THEN
        UPDATE rooms SET status = 'AVAILABLE' WHERE room_id = NEW.room_id;
    END IF;
END //
DELIMITER ;

-- View: Current occupancy
CREATE VIEW current_occupancy AS
SELECT 
    rt.type_name,
    COUNT(DISTINCT r.room_id) AS total_rooms,
    COUNT(DISTINCT CASE WHEN r.status = 'OCCUPIED' THEN r.room_id END) AS occupied_rooms,
    COUNT(DISTINCT CASE WHEN r.status = 'AVAILABLE' THEN r.room_id END) AS available_rooms
FROM room_types rt
LEFT JOIN rooms r ON rt.type_id = r.type_id
GROUP BY rt.type_id, rt.type_name;
